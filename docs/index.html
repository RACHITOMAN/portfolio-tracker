<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Tracker</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Welcome Modal (First Time Users) -->
  <div id="welcomeModal" class="modal">
    <div class="modal-content welcome-content">
      <h2>📈 Welcome to Portfolio Tracker!</h2>
      
      <div class="tutorial-section">
        <h3>🚀 Getting Started</h3>
        <ol>
          <li><strong>Get Your API Key:</strong> Sign up for free at <a href="https://twelvedata.com/" target="_blank">Twelve Data</a> to get your API key</li>
          <li><strong>Enter API Key:</strong> Click the Settings (⚙️) button and enter your API key</li>
          <li><strong>Add Transactions:</strong> Use the form to add your stock purchases, sales, and dividends</li>
          <li><strong>Create Portfolios:</strong> Organize stocks into custom portfolios (e.g., "RM", "SA", "PRO")</li>
          <li><strong>Track Performance:</strong> View real-time prices, gains/losses, and XIRR calculations</li>
        </ol>
      </div>

      <div class="tutorial-section">
        <h3>💡 Key Features</h3>
        <ul>
          <li><strong>Multiple Portfolios:</strong> Create up to 5 custom portfolios with your own names</li>
          <li><strong>Transaction Types:</strong> Buy, Sell, Dividend, and Options Premium tracking</li>
          <li><strong>Real-time Pricing:</strong> Automatic price updates from market data</li>
          <li><strong>CSV Import/Export:</strong> Bulk import and backup your transactions</li>
          <li><strong>Performance Metrics:</strong> XIRR, gain/loss tracking, weighted avg days held</li>
          <li><strong>Options Trading:</strong> Track covered calls, CSP assigned, and CSP expired</li>
        </ul>
      </div>

      <div class="tutorial-section">
        <h3>📊 Understanding Portfolios</h3>
        <p><strong>Total Portfolio:</strong> Shows all your holdings across all sub-portfolios</p>
        <p><strong>Custom Sub-portfolios:</strong> Create separate portfolios to organize your investments by strategy, account type, or any other categorization</p>
      </div>

      <div class="tutorial-section">
        <h3>🔑 Important Notes</h3>
        <ul>
          <li>API key is required for real-time price updates</li>
          <li>Your data is stored securely in Supabase cloud database</li>
          <li>Free Twelve Data plan allows 800 API calls per day (8 per minute)</li>
          <li>Prices are cached for 4 hours to conserve API usage</li>
          <li><strong>Indian Stocks:</strong> Use format like RELIANCE.NSE or TCS.BSE</li>
        </ul>
      </div>

      <button id="closeWelcomeBtn" class="btn-primary">Get Started!</button>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>⚙️ Settings</h2>
      
      <div class="settings-section">
        <h3>🔑 API Key Configuration</h3>
        <p>Enter your Twelve Data API key. <a href="https://twelvedata.com/" target="_blank">Get one free here</a>.</p>
        <input type="text" id="apiKeyInput" placeholder="Enter your API key" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px;">
        <button id="saveApiKeyBtn" class="btn-primary">Save API Key</button>
        <p id="apiKeyStatus" style="margin-top: 10px; font-weight: 600;"></p>
      </div>

      <div class="settings-section">
        <h3>📁 Manage Portfolios</h3>
        <p>Create up to 5 custom portfolios. "Total Portfolio" always shows all holdings.</p>
        <div id="portfolioList"></div>
        <button id="addPortfolioBtn" class="btn-secondary" style="margin-top: 10px;">+ Add Portfolio</button>
      </div>
    </div>
  </div>

  <div class="layout-wrapper">
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>📊 Summary</h2>
        <div class="header-buttons">
          <button id="settingsBtn" class="icon-btn" title="Settings">⚙️</button>
          <button id="helpBtn" class="icon-btn" title="Help">❓</button>
        </div>
      </div>

      <div class="portfolio-summary">
        <div class="summary-card" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
          <h3>💾 Data Safety</h3>
          <div style="font-size: 0.85em; color: #155724; line-height: 1.5;">
            ✅ Auto-saved to Supabase<br>
            💡 Export CSV for backup
          </div>
        </div>
        
        <div class="summary-card">
          <h3>Total Value</h3>
          <div class="value" id="totalValue">$0.00</div>
        </div>
        <div class="summary-card">
          <h3>Total Cost</h3>
          <div class="value" id="totalCost">$0.00</div>
        </div>
        <div class="summary-card">
          <h3>Realized Gain/Loss</h3>
          <div class="value" id="realizedGainLoss">$0.00</div>
          <div class="change" id="realizedGainPercent">0.00%</div>
        </div>
        <div class="summary-card">
          <h3>Unrealized Gain/Loss</h3>
          <div class="value" id="totalGainLoss">$0.00</div>
          <div class="change" id="totalGainLossPercent">0.00%</div>
        </div>
        <div class="summary-card">
          <h3>Holdings</h3>
          <div class="value" id="stockCount">0 Total</div>
          <div class="change" id="holdingsBreakdown"></div>
        </div>
        <div class="summary-card">
          <h3>XIRR</h3>
          <div class="value" id="portfolioXIRR">0.00%</div>
        </div>
        <div class="summary-card">
          <h3>Weighted Avg Days Held</h3>
          <div class="value" id="weightedDaysHeld">0 days</div>
        </div>
        
        <div class="summary-card" id="cashFlowCard1" style="display: none;">
          <h3>Total Cash Input</h3>
          <div class="value" id="totalCashInput">$0.00</div>
        </div>
        <div class="summary-card" id="cashFlowCard2" style="display: none;">
          <h3>Portfolio Value</h3>
          <div class="value" id="cashFlowPortfolioValue">$0.00</div>
        </div>
        <div class="summary-card" id="cashFlowCard3" style="display: none;">
          <h3>Cash-Based Gain/Loss</h3>
          <div class="value" id="cashFlowGainLoss">$0.00</div>
          <div class="change" id="cashFlowGainPercent">0.00%</div>
        </div>
      </div>
    </div>

    <div class="main-panel">
      <div class="tabs" id="mainTabs">
        <button class="tab active" data-tab="all-transactions">All Transactions</button>
        <button class="tab" data-tab="total-portfolio">Total Portfolio</button>
        <!-- Custom portfolio tabs will be added here dynamically -->
        <button class="tab" data-tab="sold-positions">Sold Positions</button>
        <button class="tab" data-tab="cash-flows">Cash Flows</button>
      </div>

      <!-- All Transactions Tab -->
      <div id="all-transactions" class="tab-content active">
        <div class="controls">
          <input type="date" id="date" required>
          <input type="text" id="symbol" placeholder="Ticker Symbol" required>
          <select id="portfolio" required>
            <option value="">Select Portfolio</option>
            <!-- Will be populated dynamically -->
          </select>
          <select id="type" required>
            <option value="">Select Type</option>
            <option value="buy">Buy</option>
            <option value="sell">Sell</option>
            <option value="dividend">Dividend</option>
            <option value="premium">Options Premium</option>
          </select>
          <select id="premiumType" style="display: none;">
            <option value="">Premium Type</option>
            <option value="covered_call">Covered Call</option>
            <option value="csp_assigned">CSP Assigned</option>
            <option value="csp_expired">CSP Expired</option>
          </select>
          <input type="number" id="quantity" placeholder="Quantity" step="any">
          <input type="number" id="price" placeholder="Price" step="0.01" required>
          <button id="addTransactionBtn" class="btn-primary">Add Transaction</button>
        </div>

        <div class="table-controls">
          <button id="importCsvBtn" class="btn-secondary">📥 Import CSV</button>
          <input type="file" id="csvFileInput" accept=".csv,.xlsx" style="display: none;">
          <button id="exportCsvBtn" class="btn-secondary">📤 Export CSV</button>
          <button id="deleteSelected" class="btn-danger">🗑️ Delete Selected</button>
          <button id="refreshPricesBtn" class="btn-secondary">🔄 Refresh Prices</button>
          <div class="search-box">
            <input type="text" id="tickerSearch" placeholder="Search ticker...">
            <button id="searchTickerBtn" class="btn-secondary">🔍</button>
            <button id="clearTickerBtn" class="btn-secondary">✖</button>
          </div>
        </div>

        <div class="table-container">
          <table id="transactionsTable">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAll"></th>
                <th class="sortable" data-sort="date">Date <span class="sort-icon">↕</span></th>
                <th class="sortable" data-sort="symbol">Ticker <span class="sort-icon">↕</span></th>
                <th>Portfolio</th>
                <th class="sortable" data-sort="type">Type <span class="sort-icon">↕</span></th>
                <th class="sortable" data-sort="quantity">Quantity <span class="sort-icon">↕</span></th>
                <th class="sortable" data-sort="price">Price <span class="sort-icon">↕</span></th>
                <th>Total</th>
                <th>Current Price</th>
              </tr>
            </thead>
            <tbody id="transactionsBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Total Portfolio Tab -->
      <div id="total-portfolio" class="tab-content">
        <div class="table-container">
          <table id="totalPortfolioTable">
            <thead>
              <tr>
                <th>Ticker</th>
                <th>Shares</th>
                <th>Avg Cost</th>
                <th>Current Price</th>
                <th>Total Cost</th>
                <th>Market Value</th>
                <th>Gain/Loss</th>
                <th>Gain/Loss %</th>
              </tr>
            </thead>
            <tbody id="totalPortfolioBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Custom Portfolio Tabs (dynamically generated) -->

      <!-- Sold Positions Tab -->
      <div id="sold-positions" class="tab-content">
        <div class="table-container">
          <table id="soldPositionsTable">
            <thead>
              <tr>
                <th>Ticker</th>
                <th>Portfolio</th>
                <th>Buy Date</th>
                <th>Sell Date</th>
                <th>Quantity</th>
                <th>Avg Buy Price</th>
                <th>Sell Price</th>
                <th>Total Cost</th>
                <th>Total Proceeds</th>
                <th>Realized Gain/Loss</th>
                <th>Realized Gain/Loss %</th>
                <th>Days Held</th>
              </tr>
            </thead>
            <tbody id="soldPositionsBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Cash Flows Tab -->
      <div id="cash-flows" class="tab-content">
        <div class="controls">
          <input type="date" id="cashFlowDate" required>
          <select id="cashFlowType" required>
            <option value="">Flow Type</option>
            <option value="deposit">Deposit</option>
            <option value="withdrawal">Withdrawal</option>
          </select>
          <input type="number" id="cashFlowAmount" placeholder="Amount" step="0.01" required>
          <button id="addCashFlowBtn" class="btn-primary">Add Cash Flow</button>
        </div>

        <div class="table-controls">
          <button id="deleteCashFlowSelected" class="btn-danger">🗑️ Delete Selected</button>
        </div>

        <div class="table-container">
          <table id="cashFlowsTable">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAllCashFlows"></th>
                <th>Date</th>
                <th>Type</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody id="cashFlowsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://dssgocxmygwnvoraqrjs.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzc2dvY3hteWd3bnZvcmFxcmpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2Njc3NzcsImV4cCI6MjA3NTI0Mzc3N30.OiF9H7pqmHYojVDBhGqeJsFzx9VbjtcwdjK59YsTjCE';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  </script>
  <script src="app.js"></script>
</body>
</html>